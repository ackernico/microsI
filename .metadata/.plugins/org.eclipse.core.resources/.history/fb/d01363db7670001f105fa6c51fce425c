/*
 Você foi convocado para projetar e testar a parte eletrônica de um lançador de foguetes.
Esse sistema conta com um display de sete segmentos, duas chaves do tipo contato momentâneo (start e stop) e um led.
O sistema lançador funciona da seguinte maneira:
- Inicialmente  no display fica aparecendo o número 9 e este número fica piscando com frequência de 1Hz. (2,0)
Ao acionar a chave start, o sistema começa uma contagem decrescente com intervalo de 1,5 segundos, e o display indica o tempo para o disparo.  (2,0)
Quando o contador chega a zero é acionado um led que indica o disparo do foguete.      (1,0)
Este é o funcionamento normal do disparador.
- Porém problemas podem acontecer nos instantes anteriores à decolagem e o disparo deve ser abortado. Para tanto existe um botão stop que, ao ser acionado, para  a contagem (1,0) decrescente e faz o display piscar com frequência de 3Hz indicando que algo de errado aconteceu e o momento em que isso aconteceu. (2,0)
Você deverá apresentar o sistema funcionando, o esquemático completo, TODOS os cálculos dos temporizadores e o código implementado
(chame o professor quando tudo estiver completo).   (2,0)
Postar o código (main.c) no classroom.

1HZ - 15999
3HZ - 5332
1.5HZ - 10665
 */
#include "stm32f4xx.h"

void delay(int t) {
    for (int i = 0; i < t; i++) {
        while ((TIM11->SR & 0x1) == 0);
        TIM11->SR &= ~0x1;
    }
}

int main(void)
{
	int botaoApertado = 0;
	int contando = 0;

	int chaveStart;
	int chaveStop;

	int cont = 0;

	int led[] = {0b00000001,
				 0b00000010,
				 0b00000100,
				 0b00001000,
				 0b00010000,
				 0b00100000,
				 0b01000000,
				 0b10000000
	};

	RCC->AHB1ENR = 0x87;
	RCC->APB2ENR |= 1 << 17;
	RCC->APB2ENR |= 1 << 18;

	GPIOA->MODER |= 0x28000000;
	GPIOC->MODER |= 0b0101010101010101;
	GPIOB->MODER &= ~0b1010;

	GPIOB->PUPDR |= 0b0101;

	TIM10->CR1 |= 0x1;
	TIM10->ARR = 999;
	TIM10->PSC = 7999;

	TIM11->CR1 |= 0b1;
	TIM11->ARR = 999;
	TIM11->PSC = 16;

  while (1)
  {
	chaveStart = GPIOB->IDR & 0b10;
	chaveStop  = GPIOB->IDR & 0b01;

	if(!chaveStart && botaoApertado != 1){
		if(contando == 1){
			TIM10->PSC = 10665;

			if(TIM10->SR & 0x1){
				switch(cont){
				case 1:
					GPIOC->ODR |= led[0];
					break;
				case 2:
					GPIOC->ODR |= led[1];
					break;
				case 3:GPIOC->ODR |= led[2];
				break;
				}
			}
			contando = 0;
			cont++;
		}
		else{
			contando = 1;
		}
		botaoApertado = 1;
		delay(200);
	}
	else{
		if(TIM10->SR&0x1){
			GPIOC->ODR ^= 0b11111111;
			TIM10->SR &= ~0b1;
		}
	}

	if(chaveStart){
		botaoApertado = 0;
	}

  }
}
